<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Korean Unicode Mapping Test</title>
    <style>
        body {
            font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', 'ÎßëÏùÄ Í≥†Îîï', 'Noto Sans CJK KR', 'D2Coding', sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .test-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        textarea {
            width: 100%;
            height: 60px;
            font-size: 18px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', 'ÎßëÏùÄ Í≥†Îîï', 'Noto Sans CJK KR', 'D2Coding', sans-serif;
        }
        button {
            margin: 5px;
            padding: 8px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>üß™ Korean Unicode Mapping Test</h1>
    <p>Testing the correct Unicode mapping for archaic jamo rendering.</p>

    <div class="test-section">
        <div class="test-title">Unicode Analysis</div>
        <div id="unicode-analysis" class="result info"></div>
    </div>

    <div class="test-section">
        <div class="test-title">Test 1: Compatibility Jamo (Current Issue)</div>
        <textarea id="test1" placeholder="Test compatibility jamo..."></textarea>
        <button onclick="testCompatibilityJamo()">Test Compatibility Jamo</button>
        <div id="result1" class="result"></div>
    </div>

    <div class="test-section">
        <div class="test-title">Test 2: Hangul Jamo (Correct Mapping)</div>
        <textarea id="test2" placeholder="Test hangul jamo..."></textarea>
        <button onclick="testHangulJamo()">Test Hangul Jamo</button>
        <div id="result2" class="result"></div>
    </div>

    <div class="test-section">
        <div class="test-title">Test 3: Mixed Approach</div>
        <textarea id="test3" placeholder="Test mixed approach..."></textarea>
        <button onclick="testMixedApproach()">Test Mixed Approach</button>
        <div id="result3" class="result"></div>
    </div>

    <div class="test-section">
        <div class="test-title">Test 4: InsertText with Correct Unicode</div>
        <textarea id="test4" placeholder="Test insertText..."></textarea>
        <button onclick="testInsertTextCorrect()">Test InsertText</button>
        <div id="result4" class="result"></div>
    </div>

    <div class="test-section">
        <div class="test-title">Reference: Expected Result</div>
        <textarea id="reference" placeholder="Paste ·ÖÄ·Ö°·Ü´ here..."></textarea>
        <div id="reference-result" class="result info">Paste ·ÖÄ·Ö°·Ü´ here to see the expected rendering</div>
    </div>

    <script>
        // Unicode mappings
        const COMPATIBILITY_JAMO = {
            initial: '·ÖÄ',  // U+1140 (4416) - Hangul Jamo
            medial: '„Öè',   // U+314F (12623) - Hangul Compatibility Jamo
            final: '„Ñ¥'     // U+3134 (12596) - Hangul Compatibility Jamo
        };

        const HANGUL_JAMO = {
            initial: '·ÖÄ',  // U+1140 (4416) - Hangul Jamo
            medial: '·Ö°',   // U+1161 (4449) - Hangul Jamo
            final: '·Ü´'     // U+11AB (4523) - Hangul Jamo
        };

        const compatibilitySequence = COMPATIBILITY_JAMO.initial + COMPATIBILITY_JAMO.medial + COMPATIBILITY_JAMO.final;
        const hangulSequence = HANGUL_JAMO.initial + HANGUL_JAMO.medial + HANGUL_JAMO.final;

        function logResult(testId, method, success, details) {
            const resultDiv = document.getElementById(`result${testId}`);
            const className = success ? 'success' : 'error';
            resultDiv.className = `result ${className}`;
            resultDiv.innerHTML = `<strong>${method}:</strong> ${success ? 'SUCCESS' : 'FAILED'}\n<strong>Details:</strong> ${details}`;
        }

        function analyzeUnicode() {
            const analysisDiv = document.getElementById('unicode-analysis');
            let analysis = 'Unicode Character Analysis:\n\n';
            
            // Compatibility Jamo
            analysis += 'Compatibility Jamo (Current - Problematic):\n';
            Object.entries(COMPATIBILITY_JAMO).forEach(([type, char]) => {
                const code = char.charCodeAt(0);
                analysis += `  ${type}: "${char}" = U+${code.toString(16).toUpperCase().padStart(4, '0')} (${code})\n`;
            });
            
            analysis += '\nHangul Jamo (Correct - Should Combine):\n';
            Object.entries(HANGUL_JAMO).forEach(([type, char]) => {
                const code = char.charCodeAt(0);
                analysis += `  ${type}: "${char}" = U+${code.toString(16).toUpperCase().padStart(4, '0')} (${code})\n`;
            });
            
            analysis += '\nKey Insight: Browsers combine Hangul Jamo (U+1100-U+11FF) but not Compatibility Jamo (U+3130-U+318F)';
            
            analysisDiv.innerHTML = analysis;
        }

        function testCompatibilityJamo() {
            const textarea = document.getElementById('test1');
            
            try {
                textarea.focus();
                const cursorPos = textarea.selectionStart;
                textarea.value = textarea.value.slice(0, cursorPos) + compatibilitySequence + textarea.value.slice(cursorPos);
                textarea.setSelectionRange(cursorPos + compatibilitySequence.length, cursorPos + compatibilitySequence.length);
                
                // Check if it rendered as separate characters
                const rendered = textarea.value.slice(cursorPos, cursorPos + compatibilitySequence.length);
                const isLinear = rendered === compatibilitySequence;
                
                logResult(1, 'Compatibility Jamo', isLinear, 
                    `Rendered: "${rendered}" (${rendered.length} chars)\nExpected: Linear rendering (separate characters)\nResult: ${isLinear ? 'Linear (as expected)' : 'Combined (unexpected)'}`);
            } catch (error) {
                logResult(1, 'Compatibility Jamo', false, `Error: ${error.message}`);
            }
        }

        function testHangulJamo() {
            const textarea = document.getElementById('test2');
            
            try {
                textarea.focus();
                const cursorPos = textarea.selectionStart;
                textarea.value = textarea.value.slice(0, cursorPos) + hangulSequence + textarea.value.slice(cursorPos);
                textarea.setSelectionRange(cursorPos + hangulSequence.length, cursorPos + hangulSequence.length);
                
                // Check if it rendered as a combined block
                const rendered = textarea.value.slice(cursorPos, cursorPos + hangulSequence.length);
                const isCombined = rendered !== hangulSequence; // If different, it combined
                
                logResult(2, 'Hangul Jamo', isCombined, 
                    `Rendered: "${rendered}" (${rendered.length} chars)\nInput: "${hangulSequence}" (${hangulSequence.length} chars)\nResult: ${isCombined ? 'Combined (SUCCESS!)' : 'Linear (failed to combine)'}`);
            } catch (error) {
                logResult(2, 'Hangul Jamo', false, `Error: ${error.message}`);
            }
        }

        function testMixedApproach() {
            const textarea = document.getElementById('test3');
            
            try {
                // Try using InsertText API with Hangul Jamo
                textarea.focus();
                
                if (document.execCommand) {
                    const success = document.execCommand('insertText', false, hangulSequence);
                    const rendered = textarea.value;
                    
                    logResult(3, 'Mixed Approach (InsertText + Hangul Jamo)', success, 
                        `Command executed: ${success}\nRendered: "${rendered}"\nLength: ${rendered.length} chars`);
                } else {
                    logResult(3, 'Mixed Approach', false, 'InsertText API not supported');
                }
            } catch (error) {
                logResult(3, 'Mixed Approach', false, `Error: ${error.message}`);
            }
        }

        function testInsertTextCorrect() {
            const textarea = document.getElementById('test4');
            
            try {
                textarea.focus();
                
                // Clear textarea first
                textarea.value = '';
                
                // Use InsertText with correct Hangul Jamo
                if (document.execCommand) {
                    const success = document.execCommand('insertText', false, hangulSequence);
                    
                    // Also try composition events
                    const compositionStartEvent = new CompositionEvent('compositionstart', { bubbles: true });
                    textarea.dispatchEvent(compositionStartEvent);
                    
                    const compositionEndEvent = new CompositionEvent('compositionend', { 
                        bubbles: true,
                        data: hangulSequence
                    });
                    textarea.dispatchEvent(compositionEndEvent);
                    
                    const rendered = textarea.value;
                    const isCombined = rendered !== hangulSequence;
                    
                    logResult(4, 'InsertText + Composition Events', isCombined, 
                        `Command executed: ${success}\nRendered: "${rendered}"\nExpected: Combined block\nResult: ${isCombined ? 'SUCCESS - Combined!' : 'Failed - Still linear'}`);
                } else {
                    logResult(4, 'InsertText + Composition Events', false, 'InsertText API not supported');
                }
            } catch (error) {
                logResult(4, 'InsertText + Composition Events', false, `Error: ${error.message}`);
            }
        }

        // Initialize
        analyzeUnicode();

        // Monitor reference textarea
        document.getElementById('reference').addEventListener('paste', function(e) {
            setTimeout(() => {
                const result = this.value;
                const resultDiv = document.getElementById('reference-result');
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `<strong>Pasted Result:</strong> "${result}" (${result.length} chars)\n<strong>Analysis:</strong> This shows how the browser should render the combined block`;
            }, 10);
        });

        // Add event listeners to monitor changes
        document.querySelectorAll('textarea').forEach((textarea, index) => {
            textarea.addEventListener('input', function() {
                console.log(`Textarea ${index + 1} changed:`, this.value);
            });
        });
    </script>
</body>
</html>
